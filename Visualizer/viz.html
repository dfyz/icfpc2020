<html>
    <head>
        <title>Galaxy brain</title>
        <meta charset="UTF-8">
        <style>
            #grid {
                display: grid;
            }
            #grid > div {
                text-align: center;
            }
        </style>
    </head>
    <body>
        <div id="grid">
        </div>

        <script>
            const url = 'http://localhost:5000/interact';

            // [[zoomedPoint, state, pictures]]
            var stateHistory = [];

            async function getNextBoard(point, state) {
                const data = {
                    'point': point,
                    'state': state,
                };
                let response = await fetch(url, {
                    method: 'POST',
                    body: JSON.stringify(data),
                    headers: {
                        'Content-Type': 'application/json'
                    },
                })

                return await response.json();
            }

            async function zoomTo(nextPoint) {
                const currentState = stateHistory.length > 0
                    ? stateHistory[stateHistory.length - 1][1]
                    : null;

                const serverResponse = await getNextBoard(nextPoint, currentState);
                const pictures = serverResponse["boards"];
                stateHistory.push([nextPoint, serverResponse['state'], pictures]);

                drawBoard(pictures);
            }

            const grid = document.getElementById('grid');

            function drawBoard(pictures) {
                var minX = Infinity;
                var maxX = -Infinity;
                var minY = Infinity;
                var maxY = -Infinity;

                for (const picture of pictures) {
                    for (const [x, y] of picture) {
                        minX = Math.min(minX, x);
                        maxX = Math.max(maxX, x);
                        minY = Math.min(minY, y);
                        maxY = Math.max(maxY, y);;
                    }
                }

                const width = maxX - minX + 1;
                const height = maxY - minY + 1;
                var pixels = [];

                grid.innerHTML = '';
                grid.style.gridTemplateColumns = `repeat(${width}, 1fr)`;
                for (var idx = 0; idx < width * height; ++idx) {
                    const pixel = document.createElement('div');
                    const x = idx % width;
                    const y = Math.floor(idx / width);
                    pixel.innerText = `(${x},${y})`;
                    pixels.push(pixel);
                    grid.appendChild(pixel);

                    pixel.onclick = function() {
                        zoomTo([x, y]);
                    };
                }

                for (const picture of pictures) {
                    for (const [x, y] of picture) {
                        const realX = x - minX;
                        const realY = y - minY;
                        const pixel = pixels[realX + realY * width];
                        pixel.style.backgroundColor = 'black';
                    }
                }
            }

            zoomTo([0, 0]);
        </script>
    </body>
</html>