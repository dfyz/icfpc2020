<html>
    <head>
        <title>Galaxy brain</title>
        <meta charset="UTF-8">
        <style>
            #grid {
                display: grid;
            }
            #grid > div {
                text-align: center;
            }
        </style>
    </head>
    <body>
        <div id="grid">
        </div>

        <script>
            // https://gist.github.com/mucar/3898821
            var colorArray = ['#FF6633', '#FFB399', '#FF33FF', '#FFFF99', '#00B3E6', 
                            '#E6B333', '#3366E6', '#999966', '#99FF99', '#B34D4D',
                            '#80B300', '#809900', '#E6B3B3', '#6680B3', '#66991A', 
                            '#FF99E6', '#CCFF1A', '#FF1A66', '#E6331A', '#33FFCC',
                            '#66994D', '#B366CC', '#4D8000', '#B33300', '#CC80CC', 
                            '#66664D', '#991AFF', '#E666FF', '#4DB3FF', '#1AB399',
                            '#E666B3', '#33991A', '#CC9999', '#B3B31A', '#00E680', 
                            '#4D8066', '#809980', '#E6FF80', '#1AFF33', '#999933',
                            '#FF3380', '#CCCC00', '#66E64D', '#4D80CC', '#9900B3', 
                            '#E64D66', '#4DB380', '#FF4D4D', '#99E6E6', '#6666FF'];
            const url = 'http://localhost:5000/interact';

            // [[zoomedPoint, state, pictures]]
            var stateHistory = [];

            async function getNextBoard(point, state) {
                const data = {
                    'point': point,
                    'state': state,
                };
                let response = await fetch(url, {
                    method: 'POST',
                    body: JSON.stringify(data),
                    headers: {
                        'Content-Type': 'application/json'
                    },
                })

                return await response.json();
            }

            async function zoomTo(nextPoint) {
                const currentState = stateHistory.length > 0
                    ? stateHistory[stateHistory.length - 1][1]
                    : null;

                const serverResponse = await getNextBoard(nextPoint, currentState);
                const pictures = serverResponse["boards"];
                stateHistory.push([nextPoint, serverResponse['state'], pictures]);

                drawBoard(pictures);
            }

            const grid = document.getElementById('grid');

            function drawBoard(pictures) {
                var minX = Infinity;
                var maxX = -Infinity;
                var minY = Infinity;
                var maxY = -Infinity;

                for (const picture of pictures) {
                    for (const [x, y] of picture) {
                        minX = Math.min(minX, x);
                        maxX = Math.max(maxX, x);
                        minY = Math.min(minY, y);
                        maxY = Math.max(maxY, y);;
                    }
                }

                const width = maxX - minX + 1;
                const height = maxY - minY + 1;
                var pixels = [];

                grid.innerHTML = '';
                grid.style.gridTemplateColumns = `repeat(${width}, 1fr)`;
                for (var idx = 0; idx < width * height; ++idx) {
                    const pixel = document.createElement('div');
                    const x = (idx % width) + minX;
                    const y = Math.floor(idx / width) + minY;
                    pixel.innerText = `(${x},${y})`;
                    pixels.push(pixel);
                    grid.appendChild(pixel);

                    pixel.onclick = function() {
                        zoomTo([x, y]);
                    };
                }

                for (var idx = 0; idx < pictures.length; ++idx) {
                    const picture = pictures[idx];
                    for (const [x, y] of picture) {
                        const realX = x - minX;
                        const realY = y - minY;
                        const pixel = pixels[realX + realY * width];
                        pixel.style.backgroundColor = colorArray[idx];
                    }
                }
            }

            zoomTo([0, 0]);
        </script>
    </body>
</html>