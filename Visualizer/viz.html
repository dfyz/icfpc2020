<html>
    <head>
        <title>Galaxy brain</title>
        <meta charset="UTF-8">
    </head>
    <body>
        <canvas id="canvas" width="720px" height="720px"></canvas>
        <script>
            const url = 'http://localhost:5000/interact';

            // [[zoomedPoint, state, pictures]]
            var stateHistory = [];

            async function getNextBoard(point, state) {
                const data = {
                    'point': point,
                    'state': state,
                };
                let response = await fetch(url, {
                    method: 'POST',
                    body: JSON.stringify(data),
                    headers: {
                        'Content-Type': 'application/json'
                    },
                })

                return await response.json();
            }

            async function zoomTo(nextPoint) {
                const currentState = stateHistory.length > 0
                    ? stateHistory[stateHistory.length - 1][1]
                    : null;

                const serverResponse = await getNextBoard(nextPoint, currentState);
                const pictures = serverResponse["boards"];
                stateHistory.push([nextPoint, serverResponse['state'], pictures]);

                drawBoard(pictures);
            }

            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            ctx.imageSmoothingEnabled = false;

            function drawBoard(pictures) {
                var minX = Infinity;
                var maxX = -Infinity;
                var minY = Infinity;
                var maxY = -Infinity;

                for (const picture of pictures) {
                    for (const [x, y] of picture) {
                        minX = Math.min(minX, x);
                        maxX = Math.max(maxX, x);
                        minY = Math.min(minY, y);
                        maxY = Math.max(maxY, y);;
                    }
                }

                const width = maxX - minX + 1;
                const height = maxY - minY + 1;

                const img = ctx.createImageData(width, height);
                var opacity = 255;
                for (const picture of pictures) {
                    for (const [x, y] of picture) {
                        const realX = x - minX;
                        const realY = y - minY;
                        const baseIndex = (realX + (realY * width)) * 4;
                        for (var idx = 0; idx < 3; ++idx) {
                            img.data[baseIndex + idx] = 0;
                        }
                        img.data[baseIndex + 3] = opacity;
                    }
                    opacity -= 10; 
                }

                const tmpCanvas = document.createElement("canvas");
                tmpCanvas.setAttribute("width", width);
                tmpCanvas.setAttribute("height", height);
                tmpCanvas.getContext('2d').putImageData(img, 0, 0);

                ctx.scale(20, 20);
                ctx.drawImage(tmpCanvas, 0, 0);
            }

            zoomTo([0, 0]);
        </script>
    </body>
</html>